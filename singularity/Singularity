bootstrap:docker
From:ubuntu:18.04


%setup
    cp gis_dependency.makefile $SINGULARITY_ROOTFS/tmp/
    cp sources.list $SINGULARITY_ROOTFS/etc/apt/sources.list

%environment
    GISBASE=/opt/eemt/grass-7.8.3
    GRASS_PROJSHARE=/usr/share/proj
    LD_LIBRARY_PATH=/opt/eemt/lib:/opt/eemt/grass-7.8.3/lib
    PATH=/opt/eemt/bin:/opt/eemt/grass-7.8.3/bin:$PATH
    PYTHONPATH=/opt/eemt/lib/python2.7/site-packages
    export GISBASE GRASS_PROJSHARE LD_LIBRARY_PATH PATH PYTHONPATH

%post

    apt-get update && apt-get upgrade -y
    apt-get install build-essential software-properties-common -y
    apt-get update && apt-get install -y \
        bison ca-certificates ccache cmake cmake-curses-gui dh-python doxygen expect flex flip gdal-bin git graphviz grass-dev libexiv2-dev libexpat1-dev libfcgi-dev libgdal-dev libgeos-dev libgsl-dev libpq-dev libproj-dev libprotobuf-dev libqca-qt5-2-dev libqca-qt5-2-plugins libqscintilla2-qt5-dev libqt5opengl5-dev libqt5serialport5-dev libqt5sql5-sqlite libqt5svg5-dev libqt5webkit5-dev libqt5xmlpatterns5-dev libqwt-qt5-dev libspatialindex-dev libspatialite-dev libsqlite3-dev libsqlite3-mod-spatialite libyaml-tiny-perl libzip-dev lighttpd locales ninja-build ocl-icd-opencl-dev opencl-headers pkg-config poppler-utils protobuf-compiler pyqt5-dev pyqt5-dev-tools pyqt5.qsci-dev python3-all-dev python3-autopep8 python3-dateutil python3-dev python3-future python3-gdal python3-httplib2 python3-jinja2 python3-lxml python3-markupsafe python3-mock python3-nose2 python3-owslib python3-plotly python3-psycopg2 python3-pygments python3-pyproj python3-pyqt5 python3-pyqt5.qsci python3-pyqt5.qtsql python3-pyqt5.qtsvg python3-pyqt5.qtwebkit python3-requests python3-sip python3-sip-dev python3-six python3-termcolor python3-tz python3-yaml qt3d-assimpsceneimport-plugin qt3d-defaultgeometryloader-plugin qt3d-gltfsceneio-plugin qt3d-scene2d-plugin qt3d5-dev qt5-default qt5keychain-dev qtbase5-dev qtbase5-private-dev qtpositioning5-dev qttools5-dev qttools5-dev-tools saga spawn-fcgi pandoc xauth xfonts-100dpi xfonts-75dpi xfonts-base xfonts-scalable xvf

    cd /tmp && \
       wget -nv http://ccl.cse.nd.edu/software/files/cctools-7.1.7-source.tar.gz && \
       tar xzf cctools-7.1.7-source.tar.gz && \
       cd cctools-7.1.7-source && \
       ./configure --prefix=/opt/eemt && \
       make && \
       make install

    cd /tmp && make -f gis_dependency.makefile

    rm -rf /tmp/build-dir /tmp/cctools*

    echo "Updating library paths"
    cd /etc/ld.so.conf.d
    echo "/opt/eemt/lib" >eemt.conf
    echo "/opt/eemt/lib64" >>eemt.conf
    echo "/opt/eemt/grass-7.8.3/lib" >grass.conf
    ldconfig

    # build info
    echo "Timestamp:" `date --utc` | tee /image-build-info.txt

